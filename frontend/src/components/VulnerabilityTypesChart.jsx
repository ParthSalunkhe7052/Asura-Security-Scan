import { useState, useEffect } from 'react'
import { PieChart, Target } from 'lucide-react'

export function VulnerabilityTypesChart({ vulnerabilities = [] }) {
  const [chartData, setChartData] = useState([])
  const [selectedType, setSelectedType] = useState(null)

  useEffect(() => {
    if (vulnerabilities && vulnerabilities.length > 0) {
      // Count vulnerabilities by type
      const typeCounts = {}
      vulnerabilities.forEach(vuln => {
        const type = vuln.vulnerability_type || 'Unknown'
        typeCounts[type] = (typeCounts[type] || 0) + 1
      })

      // Convert to array and sort
      const data = Object.entries(typeCounts)
        .map(([type, count]) => ({
          type,
          count,
          percentage: (count / vulnerabilities.length) * 100
        }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 8) // Top 8

      setChartData(data)
    }
  }, [vulnerabilities])

  if (chartData.length === 0) {
    return (
      <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-200 text-center py-12">
        <PieChart className="mx-auto text-gray-300 mb-3" size={48} />
        <p className="text-gray-600">No vulnerability data available</p>
      </div>
    )
  }

  const colors = [
    '#ef4444', // red-500
    '#f97316', // orange-500
    '#f59e0b', // amber-500
    '#eab308', // yellow-500
    '#84cc16', // lime-500
    '#22c55e', // green-500
    '#06b6d4', // cyan-500
    '#3b82f6', // blue-500
  ]

  const total = chartData.reduce((sum, item) => sum + item.count, 0)

  return (
    <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
      <div className="flex items-center gap-2 mb-6">
        <Target className="text-purple-600" size={20} />
        <h3 className="text-lg font-bold text-gray-900">Most Common Vulnerabilities</h3>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {/* Pie Chart Visualization */}
        <div className="flex items-center justify-center">
          <div className="relative w-48 h-48">
            {/* Simple pie chart using conic-gradient */}
            <div
              className="w-full h-full rounded-full"
              style={{
                background: `conic-gradient(
                  ${chartData.map((item, index) => {
                    const startAngle = chartData
                      .slice(0, index)
                      .reduce((sum, d) => sum + d.percentage, 0)
                    const endAngle = startAngle + item.percentage
                    return `${colors[index]} ${startAngle}% ${endAngle}%`
                  }).join(', ')}
                )`
              }}
            ></div>
            
            {/* Center circle for donut effect */}
            <div className="absolute inset-0 flex items-center justify-center">
              <div className="w-24 h-24 bg-white rounded-full flex flex-col items-center justify-center shadow-md">
                <span className="text-2xl font-bold text-gray-900">{total}</span>
                <span className="text-xs text-gray-600">Total</span>
              </div>
            </div>
          </div>
        </div>

        {/* Legend / List */}
        <div className="space-y-2">
          {chartData.map((item, index) => (
            <div
              key={item.type}
              className={`flex items-center justify-between p-3 rounded-lg transition-all cursor-pointer ${
                selectedType === item.type
                  ? 'bg-purple-50 border-2 border-purple-300'
                  : 'bg-gray-50 hover:bg-gray-100 border-2 border-transparent'
              }`}
              onClick={() => setSelectedType(selectedType === item.type ? null : item.type)}
            >
              <div className="flex items-center gap-3 flex-1 min-w-0">
                <div
                  className="w-4 h-4 rounded flex-shrink-0"
                  style={{ backgroundColor: colors[index] }}
                ></div>
                <span className="text-sm font-medium text-gray-900 truncate" title={item.type}>
                  {item.type}
                </span>
              </div>
              <div className="flex items-center gap-3 flex-shrink-0">
                <span className="text-xs font-medium text-gray-600">
                  {item.percentage.toFixed(1)}%
                </span>
                <span className="text-sm font-bold text-gray-900 bg-white px-2 py-1 rounded">
                  {item.count}
                </span>
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* Selected Type Details */}
      {selectedType && (
        <div className="mt-4 p-4 bg-purple-50 border border-purple-200 rounded-lg">
          <p className="text-sm font-medium text-purple-900">
            <span className="font-bold">{selectedType}</span> appears in{' '}
            {chartData.find(d => d.type === selectedType)?.count} vulnerabilities
            ({chartData.find(d => d.type === selectedType)?.percentage.toFixed(1)}% of total)
          </p>
        </div>
      )}
    </div>
  )
}

// Compact horizontal bar chart version
export function VulnerabilityTypesCompact({ vulnerabilities = [], limit = 5 }) {
  const [chartData, setChartData] = useState([])

  useEffect(() => {
    if (vulnerabilities && vulnerabilities.length > 0) {
      const typeCounts = {}
      vulnerabilities.forEach(vuln => {
        const type = vuln.vulnerability_type || 'Unknown'
        typeCounts[type] = (typeCounts[type] || 0) + 1
      })

      const data = Object.entries(typeCounts)
        .map(([type, count]) => ({ type, count }))
        .sort((a, b) => b.count - a.count)
        .slice(0, limit)

      setChartData(data)
    }
  }, [vulnerabilities, limit])

  if (chartData.length === 0) return null

  const maxCount = Math.max(...chartData.map(d => d.count))

  return (
    <div className="space-y-2">
      {chartData.map((item, index) => (
        <div key={item.type} className="flex items-center gap-3">
          <span className="text-xs text-gray-600 w-24 truncate" title={item.type}>
            {item.type}
          </span>
          <div className="flex-1 h-6 bg-gray-100 rounded-full overflow-hidden">
            <div
              className="h-full bg-gradient-to-r from-red-500 to-orange-500 transition-all duration-500"
              style={{ width: `${(item.count / maxCount) * 100}%` }}
            ></div>
          </div>
          <span className="text-sm font-bold text-gray-900 w-8 text-right">{item.count}</span>
        </div>
      ))}
    </div>
  )
}
